<?php
function getLogo($id){
	$sql ="SELECT logo FROM customer where id_customer = '$id'";
	$res = mysqli_query($GLOBALS['link'],$sql);
	$result = mysqli_fetch_array($res);
	return $result;
}
function getDataStudent($id){
	$sql =" select a.fname,a.idstudents, b.logo from students a join customer b on SUBSTRING_INDEX(a.our_id,'.','1')=b.id_customer where a.idstudents='$id'";
	$res = mysqli_query($GLOBALS['link'],$sql);
	$result = mysqli_fetch_array($res);
	return $result;

}

/*==========================CUSTOMER========================*/
function editCustomer($id){
	$sql ="SELECT * FROM customer where id_customer = '".sqlValue($id)."'";
	$res = mysqli_query($GLOBALS['link'],$sql);
	return $res;
}
function updateCustomer($id,$name,$address,$phone,$email,$logo){
	$sql = "UPDATE `customer` SET `cust_name`='".sqlValue($name)."',`address`='".sqlValue($address)."',`phone_off`='".sqlValue($phone)."',`email_off`='".sqlValue($email)."',`logo`='".sqlValue($logo)."' WHERE id_customer='$id'";
	$res = mysqli_query($GLOBALS['link'],$sql) or die('matane');
}
function deleteCustomer($id){
	$sql = "DELETE FROM customer where id_customer = '$id'";
	$res = mysqli_query($GLOBALS['link'],$sql);
}
function cekUser($id){
	$sql ="SELECT a.id_user,a.fname,a.alamat,a.phone,a.email,b.level_auth FROM users a inner join auth b on a.id_user = b.user_auth where a.cust_group = '".sqlValue($id)."'";
	$res = mysqli_query($GLOBALS['link'],$sql)or die(mysqli_error($GLOBALS['link']));
	return $res;
}


////////////////////// PIC /////////////////////


/*=============================================================================================*/

/*==========================PROGRAM========================*/
function detailPrograms ($id){
	$sql ="SELECT a.*,c.subject_name,b.percent FROM programs a inner join program_detail b on a.id_program=b.id_program inner join subject_ls c on b.id_subject=c.id_subject WHERE a.id_program = '$id'";
	$res = mysqli_query($GLOBALS['link'],$sql)or die(mysqli_error($GLOBALS['link']));
	return $res;
}
/*=============================================================================================*/
/*==========================SOAL========================*/
function showQuestion(){
	$sql = "SELECT * FROM  exam_source ";
	$res = mysqli_query($GLOBALS['link'],$sql);
	return $res;
}
function editQuestion(){
	$sql = "SELECT * FROM  exam_source ";
	$res = mysqli_query($GLOBALS['link'],$sql);
	return $res;
}
function deleteQuestion(){
	$sql = "SELECT * FROM  exam_source ";
	$res = mysqli_query($GLOBALS['link'],$sql);
	return $res;
}
//////////////////////////////// Import Soal Excel //////////////////////////////////////////

function print_upload_form(){
	echo '<div class="row">
			<div class="col-lg-12">
			<h1></h1>
		  </div>
		  <div class="col-lg-12">
		    <div class="panel panel-info">
			<div class="panel-heading">Upload Soal</div>
			<div class="panel-body">
		  <div class="col-md-6">
			';
	echo "<form role='form' name=\"fupload\" method=\"post\" enctype=\"multipart/form-data\" action=\"\">";
	echo "	<input type=\"hidden\" name=\"cmd\" value=\"upload\">
					<input type=\"hidden\" name=\"kode_soal\" value=\"\">
	<div class=\"datagrid\">
		";
	echo "<div class=\"form-group\">
			<label>Subject 1</label>
				<select class=\"form-control\" name=\"subject\">
					";	$result=showSubject();
						while($row = mysqli_fetch_array($result)){
							 echo "<option value='".$row[0]."'>".$row[1]."</option>";
						}
	echo"	</select>
		</div>";
	echo "	<div class=\"form-group\">
				<label>Data File</label>
				<input class=\"form-control\" type=\"file\" name=\"file1\">
			</div>
				<input class=\"btn btn-sm btn-primary\" type=\"submit\" id=\"btsubmit\" name=\"btsubmit\" value=\"Upload\">";
	echo "</form>
		</div>
		</div>
		<div class='col-md-6'>
		<h3>Harap diperhatikan</h3>
			<table>
				<tr>
					<td>1. </td>
					<td>Format File Upload bisa di download <a href=\"../assets/file/Example File Upload.xls\" style:'color:blue;'> Disini</a></td>
				</tr>
				<tr>
					<td>2. </td>
					<td>Format File Upload harus .xls</td>
				</tr>
				<tr>
					<td>3. </td>
					<td>Jika terdapat gambar pada soal, posisi gambar harus di dalam kolom (Seperti pada contoh)</td>
				</tr>
			</table>
		</div>
		
		</div>
	</div>
	</div>
	";
}

function print_info($data){
	$row_count = $data->rowcount(0);
	$col_count = $data->colcount(0);
	echo "Col Count:".$col_count;
	echo "<br>";
	echo "Row Count:".$row_count;
	echo "<br>";
	if ($col_count!=$GLOBALS["xl_col_count"]){
		return false;
	}else{
		return true;
	}
}

function import_excel($filename){
	global $kode_soal;
	global $kode_mapel;
	
	$filename_path="../".$GLOBALS["tmp-dir"].$filename;
	$ext = strtolower(array_pop(explode(".", $filename)));
	if ($ext=="xls"){
		$objReader = PHPExcel_IOFactory::createReader('Excel5');
	}else{
		$objReader = PHPExcel_IOFactory::createReader('Excel2007');
	}
	$objPHPExcel = $objReader->load($filename_path);
	$objWorksheet = $objPHPExcel->getActiveSheet();
	$into_fields="row_reff,kode_mapel,import_id,pertanyaan,
	jawab_a,jawab_b,jawab_c,jawab_d,jawab_e,kunci";
  $rows = $objWorksheet->getHighestRow();
  for ($row=2;$row <= $rows;$row++){
  	$data="'".$row."','".$kode_mapel."','".$_SESSION["import_id"]."'";
  	//kolom index start dari 0 (A=0,B=1 dst)
  	//kolom A skip
  	//kolom B,C,D,E,F,G,H,I,J ->tanya,a,b,c,d,e,kunci,bobot,tipe_soal
  	for ($col=1; $col <= 7; $col++){
  		$data.=",'";
  		$data.=sqlValue($objWorksheet->getCellByColumnAndRow($col, $row)->getValue());
  		$data.="'";
  	}
  	$sql="insert into exam_source_tmp(".$into_fields.") values (".$data.")";
  	//echo $sql."<br>";
  	mysqli_query($GLOBALS['link'],$sql);
  }
  //kolom K,L,M,N,O -> [img1],[img2],[img3],[img4],[img5]
  //get images
  //$GLOBALS["app-path"].$GLOBALS["img-soal-dir"]
  $imgdir="../".$GLOBALS["img-soal-dir"];
  
  foreach ($objWorksheet->getDrawingCollection() as $drawing) {
  	$coordinate = $drawing->getCoordinates();
  	preg_match("/[z-zA-Z]+/i",$coordinate,$capt);
  	$col = $capt[0];
  	unset($capt);
  	preg_match("/[0-9]+/i",$coordinate,$capt);
  	$row = $capt[0];
  	unset($capt);
  	ob_start();
    call_user_func(
        $drawing->getRenderingFunction(),
        $drawing->getImageResource()
    );
    $imageContents = ob_get_contents();
    ob_end_clean();
		
    $imgfiletype = $drawing->getMimeType();
    $imgfilename = $_SESSION["import_id"]."-".$row."-".$col ;//md5(microtime());
		$new_file="";
    switch ($imgfiletype) {

        case 'image/gif':
            $image = imagecreatefromstring($imageContents);
            imagegif($image, $imgdir.$imgfilename.".gif", 100);
            $new_file = $imgfilename.".gif";
            break;

        case 'image/jpeg':
            $image = imagecreatefromstring($imageContents);
            imagejpeg($image, $imgdir.$imgfilename.".jpg", 100);
            $new_file = $imgfilename.".jpg";
            break;

        case 'image/png':
            $image = imagecreatefromstring($imageContents);
            imagepng($image, $imgdir.$imgfilename.".png");
            $new_file = $imgfilename.".png";
            break;

        default:
            echo $imgsiletype."<br>";
    }
    if ($new_file!=""){
    	$sql="select id,pertanyaan,jawab_a,jawab_b,jawab_c,jawab_d,jawab_e,kunci from exam_source_tmp
    			where import_id='".$_SESSION["import_id"]."' and row_reff='".$row."'";
    	$rs=mysqli_query($GLOBALS['link'],$sql);
    	if ($row=mysqli_fetch_row($rs)){
    		$id=$row[0];
    		$tanya=$row[1];
    		$a=$row[2];
    		$b=$row[3];
    		$c=$row[4];
    		$d=$row[5];
    		$e=$row[6];
    		switch ($col){
    			case "I":
    				$imgtag="[img1]";
    				break;
    			case "J":
    				$imgtag="[img2]";
    				break;
    			case "K":
    				$imgtag="[img3]";
    				break;
    			case "L":
    				$imgtag="[img4]";
    				break;
    			case "M":
    				$imgtag="[img5]";
    				break;
    			default:
    				$imgtag="";
    		}
    		//echo $imgtag;
    		if ($imgtag!=""){
    			$rplwith="<img src=$path\"".$new_file."\"><br>";
    			
    			if (	(!strpos($tanya,$imgtag)) &&
    				 		(!strpos($jawab_a,$imgtag)) &&
    				 		(!strpos($jawab_b,$imgtag)) &&
    				 		(!strpos($jawab_c,$imgtag)) &&
    				 		(!strpos($jawab_d,$imgtag)) &&
    				 		(!strpos($jawab_e,$imgtag)) ) {
    				//not find [img] tag,, put img in $tanya by default
    				$tanya.= "<br>".$rplwith;
    			}else{
    				$tanya=str_replace($imgtag,$rplwith,$tanya);
    				$a=str_replace($imgtag,$rplwith,$a);
    				$b=str_replace($imgtag,$rplwith,$b);
    				$c=str_replace($imgtag,$rplwith,$c);
    				$d=str_replace($imgtag,$rplwith,$d);
    				$e=str_replace($imgtag,$rplwith,$e);
    			}
    			$sql="update exam_source_tmp set pertanyaan='".$tanya."',
    				jawab_a='".$a."',
    				jawab_b='".$b."',
    				jawab_c='".$c."',
    				jawab_d='".$d."',
    				jawab_e='".$e."'
    				where id='".$id."'";
    			mysqli_query($GLOBALS['link'],$sql);
    		}
    	}
    }
  }
  
}

function preview_soal(){
	$sql="select id,pertanyaan,jawab_a,jawab_b,jawab_c,jawab_d,jawab_e,kunci,bobot from exam_source_tmp";
	$sql.=" where import_id='".$_SESSION["import_id"]."' order by id";
	$rs=mysqli_query($GLOBALS['link'],$sql);
	$i=1;
	while ($row=mysqli_fetch_row($rs)){
		$tr_class=" class=\"alt\" ";
		#$tr_class=" class=\"alt\" ";
		if ($i % 2){
			$tr_class="";
		}
		if ($i==1){
			echo '<div class="row">
					<div class="col-lg-12">
					<h1></h1>
				  </div>
				  <div class="col-lg-12">
				    <div class="panel panel-info">
					<div class="panel-heading">Preview Soal</div>
					<div class="panel-body">
					';
			echo "<table>";
			
		}
		echo "<tr ".$tr_class.">";
		echo "<td valign=\"top\" width=\"10\"><b>".$i.".</b></td>";
		echo "<td colspan=\"2\">".str_replace("<img src=\"","<img style=\"max-width:500px;\" src=\"../".$GLOBALS["img-soal-dir"],$row[1])."</td>";
		echo "<td valign=\"top\" width=\"80\" align=\"center\"><a href=\"javascript:edit_soal_tmp(".$row[0].");\">Edit</a></td>";
		echo "</tr>";
		echo "<tr ".$tr_class.">";
		echo "<td>&nbsp;</td>";
		echo "<td valign=\"top\">";
		echo "<b>A.</b> ".str_replace("<img src=\"","<img style=\"max-width:500px;\" src=\"../".$GLOBALS["img-soal-dir"],$row[2]);
		echo "</td>";
		echo "<td valign=\"top\">";
		echo "<b>C.</b> ".str_replace("<img src=\"","<img style=\"max-width:500px;\" src=\"../".$GLOBALS["img-soal-dir"],$row[4]);
		echo "</td>";
		echo "<td>&nbsp;</td>";
		echo "</tr>";
		echo "<tr ".$tr_class.">";
		echo "<td>&nbsp;</td>";
		echo "<td valign=\"top\">";
		echo "<b>B.</b> ".str_replace("<img src=\"","<img style=\"max-width:500px;\" src=\"../".$GLOBALS["img-soal-dir"],$row[3]);
		echo "</td>";
		echo "<td valign=\"top\">";
		echo "<b>D.</b> ".str_replace("<img src=\"","<img style=\"max-width:500px;\" src=\"../".$GLOBALS["img-soal-dir"],$row[5]);
		echo "</td>";
		echo "<td>&nbsp;</td>";
		echo "</tr>";
		
		echo "<tr ".$tr_class.">";
		echo "<td>&nbsp;</td>";
		echo "<td valign=\"top\">";
		echo "<b>E.</b> ".str_replace("<img src=\"","<img style=\"max-width:500px;\" src=\"../".$GLOBALS["img-soal-dir"],$row[6]);
		echo "</td>";
		echo "<td>&nbsp;</td>";
		echo "<td>&nbsp;</td>";
		echo "</tr>";
		
		echo "<tr ".$tr_class.">";
		echo "<td>&nbsp;</td>";
		echo "<td>";
		echo "<b>Jawaban: ".$row[7]."</b><br>";
		//echo "<b>Bobot: ".$GLOBALS["bobot_soal"][$row[8]]." </b>";
		echo "</td>";
		echo "<td>";
		echo "&nbsp;";
		echo "</td>";
		echo "<td>&nbsp;</td>";
		echo "</tr>";
		$i++;
	}
	if ($i>1){
		echo "</table>";
		
	}
	//untuk reload preview setelah edit soal
	print_form_reload();
}

function finish_import(){
	$sql="INSERT INTO `exam_source`(`id_subject`, `question`, `val_a`, `val_b`, `val_c`, `val_d`, `val_e`, `val_key`)select kode_mapel,pertanyaan,jawab_a,jawab_b,jawab_c,jawab_d,jawab_e,kunci from exam_source_tmp	where import_id='".$_SESSION["import_id"]."'";
				
	mysqli_query($GLOBALS['link'],$sql)or die('error import question');
	
	//echo $sql;
	$sql="delete from exam_source_tmp where import_id='".$_SESSION["import_id"]."'";
	mysqli_query($GLOBALS['link'],$sql);
	echo ("<script LANGUAGE='JavaScript'>
		    window.alert('Upload berhasil, klik ok!');
		    window.location.href='dashboard.php?pg=admin_soal';
		    </script>");
}

function batal_import(){
	if (isset($_SESSION["import_id"])){
		$sql="delete from exam_source_tmp where import_id='".$_SESSION["import_id"]."'";
		mysqli_query($GLOBALS['link'],$sql);
		$_SESSION["import_id"]="";
	}
}

function print_finish_button(){
	echo "<form name=\"f_finish\" method=\"post\" action=\"\">";
	echo "<input type=\"hidden\" name=\"cmd\" value=\"finish\">";
	echo "<input type=\"button\" class=\"btn btn-sm btn-primary\" id=\"bt_selesai\" name=\"bt_selesai\" value=\"Selesai\" onclick=\"javascript:finish_import();\">&nbsp";
	echo "<input type=\"button\" class=\"btn btn-sm btn-danger\" id=\"bt_batal\" name=\"bt_batal\" value=\"Batal\" onclick=\"javascript:cancel_import();\">";
	echo "</form>";	
	echo "<script language=\"javascript\"> \r\n
				function cancel_import(){\r\n
				document.f_finish.cmd.value=\"batal\"; \r\n
				document.f_finish.submit(); \r\n
				}\r\n
				function finish_import(){\r\n
				document.f_finish.cmd.value=\"finish\"; \r\n
				document.f_finish.submit(); \r\n
				}\r\n
				</script>\r\n
				</div>
				</div>
				</div>
				</div>
				<br>
				<br>
				";
}

function preview_soal_old(){
	$sql="select id,pertanyaan,jawab_a,jawab_b,jawab_c,jawab_d,kunci from ".$GLOBALS["tmp_table_name"];
	$sql.=" where import_id='".$_SESSION["import_id"]."' order by id";
	$rs=mysqli_query($GLOBALS['link'],$sql);
	$i=1;
	while ($row=mysqli_fetch_row($rs)){
		if ($i==1){
			echo "<div class=\"datagrid\">";
			echo "<table>";
			echo "<thead>";
			echo "<tr><th colspan=\"4\" align=\"center\">PREVIEW SOAL</th></tr>";
			echo "</thead>";
		}
		echo "<tr>";
		echo "<td rowspan=\"3\" valign=\"top\">".$i."</td>";
		echo "<td colspan=\"2\">".$row[1]."</td>";
		echo "<td rowspan=\"3\" valign=\"middle\"><a href=\"javascript:edit_soal_tmp(".$row[0].");\">Edit</a> | delete</td>";
		echo "</tr>";
		echo "<tr>";
		echo "<td>";
		if (($row[6]=="a") || ($row[6]=="A")){
			echo "<b>A.".$row[2]."</b>";
		}else{
			echo "A.".$row[2];
		}
		echo "</td>";
		echo "<td>";
		if (($row[6]=="c") || ($row[6]=="C")){
			echo "<b>C.".$row[4]."</b>";
		}else{
			echo "C.".$row[4];
		}
		echo "</td>";
		echo "</tr>";
		echo "<tr>";
		echo "<td>";
		if (($row[6]=="b") || ($row[6]=="B")){
			echo "<b>B.".$row[3]."</b>";
		}else{
			echo "B.".$row[3];
		}
		echo "</td>";
		echo "<td>";
		if (($row[6]=="d") || ($row[6]=="D")){
			echo "<b>D.".$row[5]."</b>";
		}else{
			echo "D.".$row[5];
		}
		echo "</td>";
		echo "</tr>";
		$i++;
	}
	if ($i>1){
		echo "</table>";
		echo "</div>";
	}
	//untuk reload preview setelah edit soal
	print_form_reload();
}

/*=============================================================================================*/
/*==========================SUBJECT========================*/
function showSubject(){
	$sql = "SELECT id_subject,subject_name,level FROM  subject_ls";
	$res = mysqli_query($GLOBALS['link'],$sql);
	return $res;
}
function addSubject($id,$name,$level){
	$sql = "INSERT INTO `subject_ls`(`id_subject`, `subject_name`, `level`) VALUES ('".sqlValue($id)."','".sqlValue($name)."',".sqlValue($level).")";
	$res = mysqli_query($GLOBALS['link'],$sql)or die('Process Error please input again <a href=dashboard.php?pg=admin_soal> Here </a> <br> error : '.mysqli_error($GLOBALS['link']));
	return $sql;
}
function editSubject($id){
	$sql = "SELECT * FROM subject_ls where id_subject = '$id'";
	$res = mysqli_query($GLOBALS['link'],$sql);
	return $res;
}
function updateSubject($id,$name,$level){
	$sql = "UPDATE `subject_ls` SET `subject_name`='".sqlValue($name)."',`level`='".sqlValue($level)."' WHERE `id_subject`='".sqlValue($id)."'";
	$res = mysqli_query($GLOBALS['link'],$sql);
	return $res;
 }
function deleteSubject ($id,$id_subject){
	$sql = "DELETE from subject_ls where id=$id and id_subject='$id_subject'";
	$res = mysqli_query($GLOBALS['link'],$sql);
	return $res;
}
/*=============================================================================================*/
/*==========================VOUCHER========================*/
function showVoucher($id,$extra){
	if (isset($id) and $id!='null') {
		$sql = "select a.id_voucher,b.cust_name,c.program_name,d.available_val,a.type_voucher, a.id_program from transact_voucher a inner join customer b on a.id_customer=b.id_customer inner join programs c on a.id_program=c.id_program inner join tmp_voucher d on a.id_voucher=d.id_voucher
			where b.id_customer='$id' $extra";
	}else{
		$sql = "select a.id_voucher,b.cust_name,c.program_name,d.available_val,a.type_voucher from transact_voucher a inner join customer b on a.id_customer=b.id_customer inner join programs c on a.id_program=c.id_program inner join tmp_voucher d on a.id_voucher=d.id_voucher";
	}
	$res = mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
	return $res;
}
function addVoucher($customer,$program,$amount,$today,$type){
	if ($amount==null) {$amount=0;	}
	$sql= "select max(id_voucher) from transact_voucher";
	$carikode = mysqli_query($GLOBALS['link'],$sql) or die (mysqli_error());
		// menjadikannya array
		$datakode = mysqli_fetch_array($carikode);
		// jika $datakode
	if ($datakode) {
	    $nilaikode = substr($datakode[0], 2);
	    // menjadikan $nilaikode ( int )
	    $kode = (int) $nilaikode;
	    // setiap $kode di tambah 1
	    $kode = $kode + 1;
	    $new_id = "VC".str_pad($kode, 4, "0", STR_PAD_LEFT);
	} else {
	    $new_id = "VC0001";
	}
	$sql="INSERT INTO `transact_voucher`(`id_voucher`, `id_customer`, `id_program`, `date_create`,type_voucher) VALUES ('$new_id','".sqlValue($customer)."','".sqlValue($program)."','".sqlValue($today)."','$type')";
	mysqli_query($GLOBALS['link'],$sql) or die($sql);
	$sql="INSERT INTO tmp_voucher (`id_voucher`,`available_val`) VALUES ('$new_id','$amount')";
	mysqli_query($GLOBALS['link'],$sql) or die($sql);
	$sql="INSERT INTO `voucher_history`(`id_voucher`, `status`, `top_up`, `date`) VALUES  ('$new_id','Topup',$amount,'".sqlValue($today)."')";
	mysqli_query($GLOBALS['link'],$sql) or die($sql);
	
}
function editVoucher($id){
	$sql = "select a.id_voucher,b.cust_name,c.program_name,d.available_val from transact_voucher a inner join customer b on a.id_customer=b.id_customer
	inner join programs c on a.id_program=c.id_program 
	inner join tmp_voucher d on a.id_voucher=d.id_voucher
	where a.id_voucher='".sqlValue($id)."'";
	$res = mysqli_query($GLOBALS['link'],$sql) or die($sql);
	return $res;
}
function historyVoucher($id){
	$sql = "SELECT *, if(status = 'Topup',top_up,count(*)) total FROM voucher_history where id_voucher='".sqlValue($id)."' group by exam_code order by date desc ";
	$res = mysqli_query($GLOBALS['link'],$sql);
	return $res;
}
function historyDetail($id,$exam_code){
	$sql = "SELECT * FROM voucher_history where id_voucher='".sqlValue($id)."'AND exam_code= $exam_code";
	$res = mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
	return $res;
}
function topUpVoucher($id,$topup){
	$today = date("Y-m-d H:i:s");
	$sql = "UPDATE transact_voucher SET lastest_topup = '$today' where id_voucher='$id'";
	mysqli_query($GLOBALS['link'],$sql) or die($sql);
	$sql = "UPDATE  tmp_voucher SET available_val = available_val+'$topup' where id_voucher='$id'";
	mysqli_query($GLOBALS['link'],$sql) or die($sql);

	$sql = "INSERT INTO `voucher_history`(`id_voucher`, `status`, `date`, `top_up`) VALUES ('$id','Topup','$today',$topup)";
	mysqli_query($GLOBALS['link'],$sql);
	mysqli_close($sql);
}
function deleteVoucher ($id){
	$sql = "SELECT * FROM voucher_history where id_voucher='".sqlValue($id)."'AND exam_code= $exam_code";
	$res = mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
	return $res;
}
function cekVoucherAlocated ($voucher_id){
$qwr = "SELECT b.plan_val FROM transact_voucher a INNER JOIN tmp_voucher b ON a.id_voucher=b.id_voucher 
		WHERE a.id_voucher ='".$voucher_id."'";
	$rsqwr=mysqli_query($GLOBALS['link'],$qwr) or die(mysqli_error($GLOBALS['link']));
	$row=mysqli_fetch_row($rsqwr);
	$new_quota = $row[0] - 1;
}


/*=============================================================================================*/
/*==========================Exam========================*/


/*=============================================================================================*/
/*==========================Student========================*/
function examStudentLogin($id_peserta,$password){
	//mencocokan id peserta dan password apa 1 group 
	//tambahkan where jadwal ujian masih belum kadaluarsa
	//ketentuan : start_time + 15 menit > date now
	$sql="SELECT b.idstudents,b.fname,SUBSTRING_INDEX(b.our_id,'.','1') ,a.date,a.start_time, a.exam_group, a.id_schedule , c.id_voucher 
	FROM exam_schedule a INNER JOIN students b ON SUBSTRING_INDEX(b.our_id,'.','1') = SUBSTRING_INDEX(a.proctor,'.','1') INNER JOIN exam_group c ON a.exam_group = c.exam_code 
	WHERE b.idstudents='".sqlValue($id_peserta)."' AND a.status='run' AND a.start_time <= CURRENT_TIME() AND a.token ='".sqlValue($password)."'"; 
	$rs=mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
	if ($row=mysqli_fetch_row($rs)){
		$GLOBALS['exam_group'] = $row[5];
		$user_name=$row[1];
		$user_group='student';
		$cust_group=$row[2];
		$schedule_id=$row[6];
		$voucher_id=$row[7];
		//find role programs and margin ujian
		$qwr="SELECT a.id_voucher,a.id_customer,a.id_program,b.margin 
		FROM transact_voucher a INNER JOIN programs b ON a.id_program=b.id_program 
		WHERE a.id_voucher='".sqlValue($voucher_id)."'";
		$rsqwr=mysqli_query($GLOBALS['link'],$qwr) or die(mysqli_error($link));
		if ($rw=mysqli_fetch_row($rsqwr)){
		//find id_peserta
		// $GLOBALS['id_voucher'] = $rw[0];
		// $GLOBALS['id_customer'] = $rw[1];
			$GLOBALS['id_program'] = $rw[2];
			global $id_program;
			$sql="SELECT a.id_peserta FROM user_test a	
			WHERE a.user_id='".sqlValue($id_peserta)."' AND a.status=1 and a.id_program = '".sqlValue($id_program)."' 
			AND a.prioritas IN (
				SELECT max(prioritas) FROM user_test WHERE user_id='".sqlValue($id_peserta)."' AND status=1
				AND ifnull(eff_date,".sqlFormatDate(date("m/d/Y 23:59")).") <= ".sqlFormatDate(date("m/d/Y H:i"))." 
				AND id_program ='".sqlValue($id_program)."')";
			$rs=mysqli_query($GLOBALS['link'],$sql);
			if ($row=mysqli_fetch_row($rs)){
				$test_id=$row[0];
				if (studentOnlineCek($id_peserta)){  //login id is online?
					return 2;
				}else{
					$_SESSION["user_id"]=$id_peserta; //login id
					$_SESSION["id_peserta"]=$test_id; //test id
					$_SESSION["user_name"]=$user_name;
					$_SESSION["user_group"]=$user_group;
					$_SESSION["exam_group"]=$GLOBALS['exam_group'];
					$GLOBALS['id_participant']=$_SESSION["id_peserta"];
					logLogin($id_peserta); //log login id
					return 1;
				}
			}else{
				//loop user_test
				for ($i=1; $i <=$rw[3] ; $i++) { 
					if ($i==1) {
						$userTest=$id_peserta.".".$i;
						$skrg=sqlFormatDate(date("d/m/Y H:i:s",mktime(date(H), date(i)-1, date(s), date(m), date(d), date(Y))),"%d/%m/%Y %H:%i:%s");
						$sql="insert into user_test(user_id,id_peserta,status,prioritas,notif,eff_date,id_program) values ('".$id_peserta."','".$userTest."',1,$i,0,".$skrg.",'".sqlValue($id_program)."')";
					} else {
						$userTest=$id_peserta.".".$i;
						$sql="insert into user_test(user_id,id_peserta,status,prioritas,notif,eff_date,id_program) values ('".$id_peserta."','".$userTest."',0,$i,0,null,'".sqlValue($id_program)."')";
					}
					mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
				}
			//tidak menemukan hasil user_test
				$_SESSION["user_id"]	=$id_peserta; //login id
				$_SESSION["id_peserta"]	=$id_peserta.'.1'; //test id
				$_SESSION["user_name"]	=$user_name;
				$_SESSION["user_group"]	=$user_group;
				$_SESSION["exam_group"]=$GLOBALS['exam_group'];
				$GLOBALS['id_participant']=$_SESSION["id_peserta"];
				logLogin($id_peserta); //log login id
				return 1;
			}
		}else{	//tidak menemukan user & pass
			return 0; //invalid id/pass
		}
	}else{	
		return 0; //invalid id/pass
	}
}
function studentLoginCek(){
	if (isset($_SESSION["user_group"])){
		if ($_SESSION["user_group"]=="student"){
			return true;
		}else{
			return false;
		}
	}else{
		return false;
	}
}

function studentOnlineCek($user_id){
	$sql="select * from online_student where id_students='".$user_id."' and logout_time is null";
	$rs=mysqli_query($GLOBALS['link'],$sql);
	if ($row=mysqli_fetch_row($rs)){
		return true;
	}else{
		return false;
	}
}

function logLogout($id_peserta){
	$skrg=date("m/d/Y H:i");
	$sql="update online_student set logout_time = ".sqlFormatDate($skrg)." where id_students='".$id_peserta."'and logout_time is null";
	mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
}

function logLogin($id_peserta){
	$skrg=date("m/d/Y H:i");
	$ip=$_SERVER["REMOTE_ADDR"];
	$sql="INSERT INTO `online_student`( `id_students`, `login_time`, `logout_time`, `ip_address`) VALUES ('".$id_peserta."',".sqlFormatDate($skrg).",null,'".$ip."')";
	mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
}

function cekSession(){
	global $id_peserta;
	$sql="select id_session,exam_code from exam_session where id_student = '".sqlValue($id_peserta)."' and end_time is null";
	$rs=mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
	if (mysqli_fetch_row($rs)) {
		return true;
	} else {
		return false;
	}
}
function cekSessionExist(){
	global $id_peserta,$exam_group;
	$sql="select a.id_session,a.exam_code from exam_session a inner join exam_group b on a.exam_code=b.exam_code where a.id_student = '".sqlValue($id_peserta)."' AND b.id_voucher=(select id_voucher from exam_group where exam_code = $exam_group)";
	$rs=mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
	if ($row=mysqli_fetch_row($rs)) {
		return $row[1];
	} else {
		return false;
	}
}
function getDataExam(){
	global $id_peserta,$exam_group;
	$sql="select a.exam_group,a.id_student,b.id_voucher,c.id_program from exam_participants a inner join exam_group b on a.exam_group=b.exam_code inner join transact_voucher c on b.id_voucher = c.id_voucher where a.id_student= '".sqlValue($id_peserta)."' AND a.exam_group=$exam_group";
	$rs=mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
	$result = mysqli_fetch_array($rs);
	return $result;
}
function generateQuestion($program_id,$exam_code,$student_id){
	//get komposisi
	$sql = "select a.sum_question,a.duration,a.margin,b.id_subject,b.percent,c.`level` from programs a 
			inner join program_detail b on a.id_program=b.id_program 
			inner join subject_ls c on b.id_subject=c.id_subject
			where a.id_program='".sqlValue($program_id)."'";
	$rs=mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
		$i=0;
	while ($row=mysqli_fetch_row($rs)) {
		$sum_question=$row[0];
		$duration=$row[1];
		$margin=$row[2];
		$id_subject[$i]=$row[3];
		if ($i==0) {
			$jumlah[$i]=ceil($row[4]/100*$sum_question);
			$level[$i]=$row[5];
		} else {
			$jumlah[$i]=floor($row[4]/100*$sum_question);
			$level[$i]=$row[5];
		}
		$i++;
	}
	//random soal
		$no_quest=1;
	foreach ($id_subject as $key => $value) {
		$sql = "select * from exam_source a where a.id_subject ='".sqlValue($value)."' order by RAND() limit $jumlah[$key] ";
		$rs=mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
		while ($row=mysqli_fetch_row($rs)) {
	//random jawaban		
			$kunci[1]="A";
			$kunci[2]="B";
			$kunci[3]="C";
			$kunci[4]="D";
			$kunci[5]="E";
			$field_key[4]="A";
			$field_key[5]="B";
			$field_key[6]="C";
			$field_key[7]="D";
			$field_key[8]="E";
				$idxs = range(4, 8);
				shuffle($idxs);
				$i=1;
				foreach ($idxs as $idx) {
		  	  	$jawab[$i] = $row[$idx];
		  	  	  	if (strtoupper($row[9])==$field_key[$idx]){
			  	  		$kunci_new=$kunci[$i];
			  	  		$true=$idx;
			  	  	} 
		  	  		$i++;
				}
	//insert soal run
			$sql = "INSERT INTO `exam_run_quest`(`group_name`, `id_student`, `no_quest`, `id_quest`, `question`, `val_a`, `val_b`, `val_c`, `val_d`, `val_e`, `val_key`, `grade`, `subject`) VALUES
				($exam_code,'".sqlValue($student_id)."',$no_quest,$row[0],'".sqlValue($row[3])."','".$jawab[1]."','".$jawab[2]."','".$jawab[3]."','".$jawab[4]."','".$jawab[5]."','".$kunci_new."',$level[$key],'".sqlValue($id_subject[$key])."')";
			$no_quest++;
			$insert_quest=mysqli_query($GLOBALS['link'],$sql) or die('insert soal gagal :'.mysqli_error($GLOBALS['link']));
		}
	}
	
}
function sessionUjian($token,$id_peserta){
	$sql = "INSERT INTO `exam_session`(`id_student`, `start_time`, `end_time`, `exam_code`) VALUES
				('".$id_peserta."',".sqlFormatDate(date("m/d/Y H:i:s")).",null,'".$token."')";
	mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error('session error : '.$GLOBALS['link']));

	//record session user, start time, magin exam dan kesempatan ujian
}
function cancelLogin($id_peserta,$exam_group){
	$sql = "delete from exam_participants where id_student = '$id_peserta' and exam_group =$exam_group";
	
	mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error('Cancel Login : '.$GLOBALS['link']));

}
/*=============================================================================================*/
/*====================================  Report  =============================================*/
function showReport($id,$extra){
	if (isset($extra)) {
		$sql = "select a.*,b.program_name from exam_report a inner join programs b on SUBSTRING_INDEX(SUBSTRING_INDEX(a.id_report,'.',2),'.',-1)=b.id_program where SUBSTRING_INDEX(a.id_report,'.',1)='$id' and b.id_program='$extra'";
	}else{
		$sql = "select a.*,b.program_name from exam_report a inner join programs b on SUBSTRING_INDEX(SUBSTRING_INDEX(a.id_report,'.',2),'.',-1)=b.id_program where SUBSTRING_INDEX(a.id_report,'.',1)='$id'";
	}
	$res = mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
	return $res;
}
function createReport($id_g,$name,$date1,$date2){
	$today = date("Y-m-d H:i:s");
	$sql="select SUBSTRING_INDEX(SUBSTRING_INDEX(a.group_name,'.',2),'.',-1)program_id from exam_group a inner join exam_schedule b on a.exam_code=b.exam_group where b.date >='$date1' and b.date<='$date2' and SUBSTRING_INDEX(a.group_name,'.',1)='$id_g'group by program_id";
	$result = mysqli_query($GLOBALS['link'],$sql) or die (mysqli_error());
	while ($row = mysqli_fetch_row($result)) {
		$sql= "select max(a.id_report) from exam_report a where SUBSTRING_INDEX(SUBSTRING_INDEX(a.id_report,'.',2),'.',-1)='$row[0]'";
		$carikode = mysqli_query($GLOBALS['link'],$sql) or die (mysqli_error());
			// menjadikannya array
			$datakode = mysqli_fetch_array($carikode);
			// jika $datakode
		if ($datakode) {
		    $nilaikode = substr($datakode[0], 2);
		    // menjadikan $nilaikode ( int )
		    $kode = (int) $nilaikode;
		    // setiap $kode di tambah 1
		    $kode = $kode + 1;
		    $new_id = $id_g.".".$row[0].".".str_pad($kode, 4, "0", STR_PAD_LEFT);
		} else {
		    $new_id = $id_g.".".$row[0].".1";
		}
		print_r($new_id);
		echo "<br>";
	}
	die('disini');
	
	if (isset($extra)) {
	$sql = "select a.id_voucher,b.cust_name,c.program_name,d.available_val,a.type_voucher from transact_voucher a inner join customer b on a.id_customer=b.id_customer inner join programs c on a.id_program=c.id_program inner join tmp_voucher d on a.id_voucher=d.id_voucher
			where b.id_customer='$id'";
	}else{
			$sql = "select a.*,b.program_name from exam_report a inner join programs b on SUBSTRING_INDEX(SUBSTRING_INDEX(a.id_report,'.',2),'.',-1)=b.id_program where SUBSTRING_INDEX(a.id_report,'.',1)='$id'";
	}
	$res = mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
	return $res;
}

function tanggal_indo($tanggal)
{
	$bulan = array (1 =>   'Januari',
				'Februari',
				'Maret',
				'April',
				'Mei',
				'Juni',
				'Juli',
				'Agustus',
				'September',
				'Oktober',
				'November',
				'Desember'
			);
	$split = explode('-', $tanggal);
	return $split[2] . ' ' . $bulan[ (int)$split[1] ] . ' ' . $split[0];
}

function admRpt_Cust($start,$end,$by,$cust){
	$len = count($cust);
	foreach ($cust as $key => $value) {
		if ($key<$len-1) {
			$list_cust.="'".$value."',";
		} else {
			$list_cust.="'".$value."'";
		}
		//echo $list_cust;
	}
	if ($by=='Voucher') {
		$sql = "select a.id_customer,a.cust_name, b.id_voucher, b.id_program, d.available_val, b.lastest_topup,count(if(c.`status`='Usage',1,null))pakai, sum(c.top_up)top_up ,c.`status` 
		from customer a 
		inner join transact_voucher b on a.id_customer=b.id_customer 
		left join voucher_history c on b.id_voucher=c.id_voucher 
		left join tmp_voucher d on b.id_voucher = d.id_voucher 
		where a.id_customer in ($list_cust) 
		group by b.id_voucher
		order by a.id_customer";
	} elseif ($by=='Exam') {
		$sql = "select c.id_customer,c.cust_name,b.group_name,a.date,a.classroom,d.fname,b.count_stu,e.use_val,e.unuse_val from exam_schedule a inner join exam_group b on a.exam_group=b.exam_code inner join customer c on SUBSTRING_INDEX(b.group_name,'.',1) = c.id_customer inner join users d on a.proctor = d.id_user inner join exam_group_log e on b.exam_code=e.id_group where c.id_customer in($list_cust) 
		";
		
	} elseif ($by=='Program') {
		$sql = "select GROUP_CONCAT(a.exam_code SEPARATOR ',')exam_code,c.program_name,b.cust_name,count(*)ujian from exam_group a inner join customer b on SUBSTRING_INDEX(a.group_name,'.',1) = b.id_customer inner join programs c on SUBSTRING_INDEX(SUBSTRING_INDEX(a.group_name,'.',2),'.',-1) = c.id_program group by SUBSTRING_INDEX(SUBSTRING_INDEX(a.group_name,'.',2),'.',-1)";
	}
		//and c.date >='$start' and c.date <= '$end' 

	$res = mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
	return $res;
	
}
function admRpt_Voucher($start,$end,$voucher){
	$len = count($voucher);
	foreach ($voucher as $key => $value) {
		if ($key<$len-1) {
			$list_voucher.="'".$value."',";
		} else {
			$list_voucher.="'".$value."'";
		}
		//echo $list_cust;
	}
	$sql = "select a.id_voucher, d.cust_name, c.program_name, a.group_name, a.count_stu, b.use_val, b.unuse_val,a.exam_code,e.date,e.start_time from exam_group a 
		inner join exam_group_log b on a.exam_code=b.id_group
		inner join programs c on SUBSTRING_INDEX(SUBSTRING_INDEX(a.group_name,'.',2),'.',-1) = c.id_program
		inner join customer d on SUBSTRING_INDEX(a.group_name,'.',1)=d.id_customer
		inner join exam_schedule e on a.exam_code=e.exam_group
		where a.id_voucher in ($list_voucher) 
		and e.date>='$start' and e.date<='$end'";
	$res = mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
	return $res;
	
}
function admRpt_CustProgram($start,$end,$by,$cust){
	$len = count($cust);
	foreach ($cust as $key => $value) {
		if ($key<$len-1) {
			$list_cust.="'".$value."',";
		} else {
			$list_cust.="'".$value."'";
		}
		//echo $list_cust;
	}
	$sql = "select a.id_customer,a.cust_name, b.id_voucher, b.id_program, d.available_val, b.lastest_topup,count(if(c.`status`='Usage',1,null))pakai, sum(c.top_up)top_up ,c.`status` 
		from customer a 
		inner join transact_voucher b on a.id_customer=b.id_customer 
		left join voucher_history c on b.id_voucher=c.id_voucher 
		left join tmp_voucher d on b.id_voucher = d.id_voucher 
		where a.id_customer in ($list_cust) 
		group by b.id_voucher
		order by a.id_customer";
		//and c.date >='$start' and c.date <= '$end' 
	die($sql);
	$res = mysqli_query($GLOBALS['link'],$sql) or die(mysqli_error($GLOBALS['link']));
	return $res;
	
}
/*=============================================================================================*/
/*======================================= Export Excel ========================================*/

function outputXLS(){
	global $rpt_id;
	require_once "../".$GLOBALS["xls-reader-dir"]."PHPExcel.php";
	$objPHPExcel = new PHPExcel();
	$objPHPExcel->getProperties()->setCreator("Trust")
							 ->setLastModifiedBy("Trust")
							 ->setTitle("Exam Report")
							 ->setSubject("Exam Report")
							 ->setDescription("Exam Report")
							 ->setKeywords("Exam Report")
							 ->setCategory("Exam Report");

	$sql="select date_format(tanggal_ujian,'%d-%M-%Y') tgl,kelas,nama_group,test_admin,nim,nama,nilai1,nilai2,lulus,
						w1,e1,p1,durasi1,w2,e2,p2,durasi2
				from rpt_data
			where rpt_id='".$rpt_id."'
			order by tanggal_ujian,kelas,nama_group,test_admin,
					cast(replace(nilai1,'%','') as unsigned) desc,
					cast(replace(nilai2,'%','') as unsigned) desc,
					durasi1,durasi2,
					nama";
	//echo $sql;
	$i=0; $no=0;//start write on row 3
	$sheet_id=-1;
	$rs=mysql_query($sql);
	$prev_tanggal="";
	$prev_kelas="";
	$prev_group="";
	while ($row=mysql_fetch_row($rs)){
		$tanggal=$row[0];
		$kelas=$row[1];
		$group=$row[2];
		$test_admin=$row[3];
		$nim=$row[4];
		$nama=$row[5];
		$nilai1=$row[6];
		$nilai2=$row[7];
		$lulus=$row[8];
		$w1=$row[9];$e1=$row[10];$p1=$row[11];$durasi1=$row[12];
		$w2=$row[13];$e2=$row[14];$p2=$row[15];$durasi2=$row[16];
		if (($tanggal!=$prev_tanggal) or
		    ($kelas!=$prev_kelas) or
		    ($group!=$prev_group))
		 {
		 	if ($tanggal!=$prev_tanggal){
		 		$sheet_id++; //new sheet
		 		if ($sheet_id>0){
		 			$objPHPExcel->createSheet();
		 		}
		 		$i=0; //start from first row again
		 	}
			$i++; //beri jarak 1 baris
			//print header
			$objPHPExcel->setActiveSheetIndex($sheet_id)
						->setCellValue('A'.$i, 'NO')
            ->setCellValue('B'.$i, 'TANGGAL')
            ->setCellValue('C'.$i, 'KELAS')
            ->setCellValue('D'.$i, 'GROUP')
            ->setCellValue('E'.$i, 'TEST ADMIN')
            ->setCellValue('F'.$i, 'NIM')
            ->setCellValue('G'.$i, 'NAMA')
            ->setCellValue('H'.$i, 'NILAI 1')
            ->setCellValue('I'.$i, 'NILAI 2')
            ->setCellValue('J'.$i, 'KETERANGAN')
            ->setCellValue('K'.$i, 'W1')
            ->setCellValue('L'.$i, 'E1')
            ->setCellValue('M'.$i, 'P1')
            ->setCellValue('N'.$i, 'DURASI 1')
            ->setCellValue('O'.$i, 'W2')
            ->setCellValue('P'.$i, 'E2')
            ->setCellValue('Q'.$i, 'P2')
            ->setCellValue('R'.$i, 'DURASI 2');

			$i++;
			$no=0; //reset nomer
		}
		$no++;
		//print data
		$objPHPExcel->setActiveSheetIndex($sheet_id)
            ->setCellValue('A'.$i, $no)
            ->setCellValue('B'.$i, $tanggal)
            ->setCellValue('C'.$i, $kelas)
            ->setCellValue('D'.$i, $group)
            ->setCellValue('E'.$i, $test_admin)
            ->setCellValue('G'.$i, $nama)
            ->setCellValue('H'.$i, $nilai1)
            ->setCellValue('I'.$i, $nilai2)
            ->setCellValue('J'.$i, $lulus)
            ->setCellValue('K'.$i, $w1)
            ->setCellValue('L'.$i, $e1)
            ->setCellValue('M'.$i, $p1)
            ->setCellValue('N'.$i, $durasi1)
            ->setCellValue('O'.$i, $w2)
            ->setCellValue('P'.$i, $e2)
            ->setCellValue('Q'.$i, $p2)
            ->setCellValue('R'.$i, $durasi2);
		$objPHPExcel->setActiveSheetIndex($sheet_id)->setCellValueExplicit('F'.$i, $nim, PHPExcel_Cell_DataType::TYPE_STRING);
		$prev_tanggal=$tanggal;
		$prev_kelas=$kelas;
		$prev_group=$group;
		$i++;
	}
	$objPHPExcel->setActiveSheetIndex(0);

	header('Content-Type: application/vnd.ms-excel');
	header('Content-Disposition: attachment;filename="report.xls"');
	header('Cache-Control: max-age=0');
	// If you're serving to IE 9, then the following may be needed
	header('Cache-Control: max-age=1');

	// If you're serving to IE over SSL, then the following may be needed
	header ('Expires: Mon, 26 Jul 1997 05:00:00 GMT'); // Date in the past
	header ('Last-Modified: '.gmdate('D, d M Y H:i:s').' GMT'); // always modified
	header ('Cache-Control: cache, must-revalidate'); // HTTP/1.1
	header ('Pragma: public'); // HTTP/1.0

	$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');
	$objWriter->save('php://output');
	exit;
}
/*=============================================================================================*/

?>